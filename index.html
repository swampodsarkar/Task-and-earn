<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Task Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<div class="container mt-5">
<div id="loginDiv" class="card p-4">
<h2>Login / Register</h2>
<input type="text" id="username" class="form-control mb-2" placeholder="Username">
<input type="email" id="email" class="form-control mb-2" placeholder="Email">
<button class="btn btn-primary" onclick="loginUser()">Login</button>
</div>

<div id="dashboardDiv" style="display:none;">
<h2>Welcome, <span id="userDisplay"></span></h2>
<h4>Your Points: <span id="userPoints">0</span></h4>
<h4>Available Tasks:</h4>
<div id="tasksList"></div>
<br>
<button class="btn btn-success" onclick="withdrawRequest()">Withdraw</button>
<button class="btn btn-secondary" onclick="logoutUser()">Logout</button>
</div>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAhSjh1VxQFrzslIwOZ1yOxLYuNT2Le_sg",
  authDomain: "fram-and-go.firebaseapp.com",
  databaseURL: "https://fram-and-go-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "fram-and-go",
  storageBucket: "fram-and-go.firebasestorage.app",
  messagingSenderId: "781295119002",
  appId: "1:781295119002:web:3d84890a0bb85e5d1c0d23",
  measurementId: "G-H30RNBNE6X"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUserId = null;

function loginUser(){
    const username = document.getElementById('username').value.trim();
    const email = document.getElementById('email').value.trim();
    if(!username || !email){ alert("Enter both fields"); return; }
    currentUserId = email.replace(/[.#$[\]]/g,"_");
    db.ref('users/' + currentUserId).get().then(snapshot=>{
        if(!snapshot.exists()){
            db.ref('users/' + currentUserId).set({username,email,points:0,completedTasks:{}});
        }
        showDashboard(username);
    });
}

function logoutUser(){
    currentUserId = null;
    document.getElementById('loginDiv').style.display='block';
    document.getElementById('dashboardDiv').style.display='none';
}

function showDashboard(username){
    document.getElementById('userDisplay').innerText = username;
    document.getElementById('loginDiv').style.display='none';
    document.getElementById('dashboardDiv').style.display='block';
    loadTasks();
    updatePoints();
}

function loadTasks(){
    db.ref('tasks').get().then(snapshot=>{
        const tasksList = document.getElementById('tasksList');
        tasksList.innerHTML='';
        if(!snapshot.exists()){ tasksList.innerHTML="<p>No tasks available</p>"; return; }
        snapshot.forEach(child=>{
            const t = child.val();
            const id = child.key;
            const div = document.createElement('div');
            div.className = 'card p-2 mb-2';
            div.innerHTML = `<strong>${t.title}</strong> - Points: ${t.points} 
            <a href="${t.link}" target="_blank" class="btn btn-sm btn-primary ms-2" onclick="completeTask('${id}',${t.points})">Complete</a>`;
            tasksList.appendChild(div);
        });
    });
}

function updatePoints(){
    db.ref('users/' + currentUserId + '/points').get().then(snap=>{
        document.getElementById('userPoints').innerText = snap.val() || 0;
    });
}

function completeTask(taskId,points){
    db.ref('users/' + currentUserId + '/completedTasks/' + taskId).get().then(snap=>{
        if(snap.exists()){ alert("Already completed"); return; }
        db.ref('users/' + currentUserId + '/completedTasks/' + taskId).set(true);
        db.ref('users/' + currentUserId + '/points').transaction(p=> (p||0)+points);
        setTimeout(updatePoints,200);
    });
}

function withdrawRequest(){
    db.ref('users/' + currentUserId + '/points').get().then(snap=>{
        const points = snap.val()||0;
        if(points<50){ alert("Minimum 50 points required"); return; }
        const newRequest = db.ref('withdraw_requests').push();
        newRequest.set({userId:currentUserId,points,status:"pending"});
        db.ref('users/' + currentUserId + '/points').set(0);
        updatePoints();
        alert("Withdraw request submitted!");
    });
}
</script>
</body>
</html>
